# Print the Plotly object as an HTML output
browsable(html_output)
baseline_data |>
mutate(`protein (g)_corrected range` = cut(`Protein (g)_corrected`,
breaks = seq(0, ceiling(max(`Protein (g)_corrected`, na.rm = TRUE)/10)*10, by = 5),
include.lowest = TRUE,
right = TRUE)) |>
count(`protein (g)_corrected range`) |>
summarise(
`protein (g)_corrected range` = `protein (g)_corrected range`,
Frequency = n, `percent of population` = (100 * n / sum(n)) |> round(2)
) |> ungroup() |>
datatable(options = list(pageLength = 20,
scrollX = TRUE,
dom = 'Bfrtip'), filter = 'top',
extensions = 'Buttons',
caption = "Distribution of grams of protein (corrected) `in ingredients`",)
# Visualize the results
p = ggplot(baseline_data, aes(x = `Protein (g)_corrected`, fill = age_group)) +
geom_histogram(aes(y = after_stat(count)/sum(after_stat(count)) * 100),
color = "black", binwidth = 2, position = "dodge") +
theme_minimal() +
ggtitle("Distribution of corrected protein (g) values by age group"  |> str_wrap()) +
xlab("Protein (g)") + ylab("Percentage") +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), plot.title = element_text(size = 10))   # Angle x-axis tick labels at 90 degrees
# Convert ggplot object to plotly object
plotly_obj = ggplotly(p)
# Define HTML output
html_output = tagList(
tags$div(plotly_obj, style = "margin:5px;")
)
# Print the Plotly object as an HTML output
browsable(html_output)
baseline_data |>
mutate(`protein (g)_corrected range` = cut(`Protein (g)_corrected`,
breaks = seq(0, ceiling(max(`Protein (g)_corrected`, na.rm = TRUE)/10)*10, by = 5),
include.lowest = TRUE,
right = TRUE)) |>
count(`protein (g)_corrected range`, age_group) |>
group_by(age_group) |>
summarise(
`protein (g)_corrected range` = `protein (g)_corrected range`,
Frequency = n, `percent of age group` = (100 * n / sum(n)) |> round(2)
) |> ungroup() |>
mutate(
`percent of population` = (100 * Frequency / sum(Frequency)) |> round(2)) |>
relocate(age_group, .before = Frequency) |>
arrange(`protein (g)_corrected range`, age_group) |>
datatable(options = list(pageLength = 15,
scrollX = TRUE,
dom = 'Bfrtip'), filter = 'top',
extensions = 'Buttons',
caption = "Distribution of grams of protein (corrected) `in ingredients by age_group`",)
if(!"GENFOOD-Protein Digestibility-250925-142812 extracted.csv" %in% list.files(here())) {
digestibility_source = "GENFOOD-Protein Digestibility-250925-142812.pdf"
digestibility_table = extract_areas(digestibility_source)[1:10]
digestibility_col_names = c("Food item", "PDCA", "Protein", "Source")
digestibility_table = digestibility_table |>
map(~{
if(sum(names(.x) %in% digestibility_col_names) == 4) {
.x = .x[-(1:2), c(1,3)] |>
rename_with(~c("Food item", "Protein_digestibility")) |>
filter(!is.na(Protein_digestibility))
} else {
.x = .x[ , c(1, 3)] |>
rbind(names(.x)[c(1, 3)]) |>
rename_with(~c("Food item", "Protein_digestibility")) |>
filter(!is.na(Protein_digestibility))
}
}) |> bind_rows() |>
mutate(
Protein_digestibility = ifelse(
grepl("^\\.", Protein_digestibility),  # Check if the value starts with a dot
NA_character_,  # Replace with NA
Protein_digestibility  # Keep the original value
),
Protein_digestibility = as.numeric(Protein_digestibility)  # Convert to numeric
)
write_csv(digestibility_table, file = here("GENFOOD-Protein Digestibility-250925-142812 extracted.csv"))
}
protein_digestibility_csv = read_csv(here("Protein digestibility.csv")) |>
rename(Protein_digestibility = `True fecal digestibility`, Protein_Source = `Protein Source`) |>
select(Protein_Source, Protein_digestibility) # from csv file shared
protein_digestibility_pdf = read_csv(file = here("GENFOOD-Protein Digestibility-250925-142812 extracted.csv")) |>
rename(Protein_Source = `Food item`) |> select(Protein_Source, Protein_digestibility) # from protein digestibility pdf from link
protein_digestibility = protein_digestibility_csv |>
full_join(protein_digestibility_pdf) |> arrange(Protein_Source) |> na.omit() # |> mutate(Protein_Source_simplified = word(Protein_Source))
nrow(protein_digestibility)
# Protein digestibility data
# protein_digestibility <- protein_digestibility %>%
#   mutate(
#     Protein_Source_simplified = sapply(Protein_Source, clean_for_digestibility)
#   )
protein_digestibility = protein_digestibility |>
mutate(
Protein_Source_simplified = Protein_Source |> tolower(),
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(tea).*white") ~ "tea white",
stringr::str_detect(Protein_Source_simplified, "(tea).*black") ~ "tea black",
stringr::str_detect(Protein_Source_simplified, "\\btea\\b") ~ "tea",
TRUE ~ Protein_Source_simplified),  # Retain existing value if none of the conditions are met
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(beef|cow).*(low fat|lowfat)") ~ "beef low",  # Replace if "medium fat beef"
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "fish") ~ "fish",
stringr::str_detect(Protein_Source_simplified, "(nile).*perch") ~ "nile perch",
stringr::str_detect(Protein_Source_simplified, "mbuta") ~ "nile perch",
stringr::str_detect(Protein_Source_simplified, "tilapia") ~ "tilapia",
TRUE ~ Protein_Source_simplified),  # Retain existing value if none of the conditions are met
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "chicken"), "chicken", Protein_Source_simplified), # replace everything that contains chicken to "chicken"
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "chickpea|chickpeas|chick peas") ~ "chick peas",
stringr::str_detect(Protein_Source_simplified, "peas * green") ~ "peas",
stringr::str_detect(Protein_Source_simplified, "peas") ~ "peas",
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "pilau masala") ~ "masala",
stringr::str_detect(Protein_Source_simplified, "(rice).*white") ~ "rice white",
stringr::str_detect(Protein_Source_simplified, "(rice).*(brown)") ~ "rice brown",
stringr::str_detect(Protein_Source_simplified, "brown rice") ~ "rice brown",
stringr::str_detect(Protein_Source_simplified, "rice|pilau") ~ "rice white",
TRUE ~ Protein_Source_simplified),  # Retain existing value if none of the conditions are met
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(wheat).*bread") ~ "wheat bread",
TRUE ~ Protein_Source_simplified),  # Retain existing value if none of the conditions are met
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(beans|bean).*red") ~ "beans red",  # Replace if "beans french"
stringr::str_detect(Protein_Source_simplified, "beans|bean|geans dried") ~ "beans",  # Replace if "beans"
TRUE ~ Protein_Source_simplified
),
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "egg"), "eggs", Protein_Source_simplified), # replace everything that contains egg to "eggs"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "greens grams|green grams|ndengu|ndegu|baazi green|Gram"), "green gram", Protein_Source_simplified), # replace everything that contains ndengu to "green grams"
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(green|grain).*maize") ~ "maize grain",
stringr::str_detect(Protein_Source_simplified, "(maize|ugali).*unrefined") ~ "maize unrefined",
stringr::str_detect(Protein_Source_simplified, "(maize|ugali).*refined") ~ "maize refined",
stringr::str_detect(Protein_Source_simplified, "maize|ugali|flour all purpose") ~ "maize unrefined",
stringr::str_detect(Protein_Source_simplified, "pepper") ~ "pilipili",
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(milk).*(cow).*fermented") ~ "yoghurt",  # Replace if "fermented cow milk"
stringr::str_detect(Protein_Source_simplified, "mala|yoghurt") ~ "yoghurt",
stringr::str_detect(Protein_Source_simplified, "(milk).*cow") ~ "milk cow",  # Replace if "cow milk"
stringr::str_detect(Protein_Source_simplified, "(milk).*camel") ~ "milk camel",  # Replace if "camel milk"
stringr::str_detect(Protein_Source_simplified, "(milk).*goat") ~ "milk goat",  # Replace if "goat milk"
stringr::str_detect(Protein_Source_simplified, "milk|cow milk") ~ "milk cow",  # Replace if "liver" is found
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "weetaibix|WEETABIX") ~ "weetabix",
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "(wheat).*flour"), "wheat flour", Protein_Source_simplified), # replace everything that contains wheat to "wheat"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "casein"), "casein", Protein_Source_simplified), # replace everything that contains casein to "casein"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "managu|kienyeji green|nightshade"), "blacknightshade", Protein_Source_simplified), # replace everything that contains managu to "managu"
Protein_Source_simplified = case_when(
str_detect(Protein_Source_simplified, "Orange, pulp, raw") ~ "orange",
TRUE ~ Protein_Source_simplified
),
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "coriander|corriander|dhania|dhani"), "dhania", Protein_Source_simplified), # replace everything that contains capsicum to "capsicum"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "coconut"), "coconut", Protein_Source_simplified), # replace everything that contains coconut to "coconut"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "lentil"), "lentil", Protein_Source_simplified), # replace everything that contains lentil to "lentil"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "cowpea|cow pea"), "cowpeas", Protein_Source_simplified), # replace everything that contains cow pea green to "cowpeas"
Protein_Source_simplified = case_when(
stringr::str_detect(Protein_Source_simplified, "(sukuma|sukjma|kales|green fresh without stalks|kanjera|kansela).*ethiopia") ~ "ethiopian kales",
stringr::str_detect(Protein_Source_simplified, "sukuma|sukjma|kales|green fresh without stalks|kanjera|kansela") ~ "kales",
TRUE ~ Protein_Source_simplified),  # Retain the original value if no match
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "oil |cooking fat|o l|oil,"), "oil", Protein_Source_simplified), # replace everything that contains oil to "oil"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "potato"), "potato", Protein_Source_simplified), # replace everything that contains potato to "potato"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "pumpkin seed"), "pumpkin seed", Protein_Source_simplified), # replace everything that contains pumpkin seed to "pumpkin seed"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "omena|dagaa"), "omena", Protein_Source_simplified), # replace everything that contains omena to "omena"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "sardine|sardines"), "sardine", Protein_Source_simplified), # replace everything that contains omena to "omena"
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "soy protein isolate"), "soy flour", Protein_Source_simplified),
Protein_Source_simplified = ifelse(stringr::str_detect(Protein_Source_simplified, "sorghum"), "sorghum", Protein_Source_simplified) # replace everything that contains sorghum to "sorghum"
)
protein_digestibility |>
# where multiple records exist, take the median
group_by(Protein_Source_simplified) |>
summarise(
Protein_Source = Protein_Source[1],
Protein_digestibility = median(Protein_digestibility, na.rm = TRUE)) |>
relocate(c(Protein_Source, Protein_Source_simplified, Protein_digestibility), .before = everything()) |>
ungroup()  |> distinct(Protein_Source_simplified, .keep_all = TRUE)
source("improved_fuzzy_matching.R")
# optimize ingredient names for protein digestibility
baseline_data = baseline_data |>
mutate(
ingredient_name_simplified_digestibility = ingredient_name_simplified,
ingredient_name_simplified_digestibility = case_when(
stringr::str_detect(ingredient_name_simplified_digestibility, "flour.*brown") ~ "millet",
stringr::str_detect(ingredient_name_simplified_digestibility, "maize grain") ~ "maize unrefined",
stringr::str_detect(ingredient_name_simplified_digestibility, "(maize|ugali|white).*unrefined") ~ "maize unrefined",
stringr::str_detect(ingredient_name_simplified_digestibility, "(maize|white|ugali).*(sifted|refined|fortified|grade|jogoo|pembe|shujaa|soko)") ~ "maize refined",
stringr::str_detect(ingredient_name_simplified_digestibility, "ringows") ~ "maize refined",
stringr::str_detect(ingredient_name_simplified_digestibility, "maize|ugali") ~ "maize unrefined", # flour all purpose to move to wheat
stringr::str_detect(ingredient_name_simplified_digestibility, "flour all purpose") ~ "wheat flour",
TRUE ~ ingredient_name_simplified_digestibility),  # Retain the original value if no match
ingredient_name_simplified_digestibility  = case_when(
stringr::str_detect(ingredient_name_simplified_digestibility, "milk mala") ~ "milk cow",
TRUE ~ ingredient_name_simplified_digestibility),  # Retain existing value if none of the conditions are met
ingredient_name_simplified_digestibility = case_when(
stringr::str_detect(ingredient_name_simplified_digestibility, "(beef|cow).*(low fat|lowfat)") ~ "beef low",  # Replace if "medium fat beef"
stringr::str_detect(ingredient_name_simplified_digestibility, "beef") ~ "beef",
stringr::str_detect(ingredient_name_simplified_digestibility, "sardine|omena") ~ "fish",
stringr::str_detect(ingredient_name_simplified_digestibility, "(beans|bean).*red") ~ "beans red",  # Replace if "beans french"
stringr::str_detect(ingredient_name_simplified_digestibility, "beans") ~ "beans",
TRUE ~ ingredient_name_simplified_digestibility),  # Retain the original value if no match
)
# 5. Update merged_data with Protein_digestibility and Protein_Source based on partial matches
cat("Excluding these ingredients from fuzzy matching (have no match hence prevent error matching):\n")
excluded_ingredients <- c("soy flour", "oil", "sugar", "tomato", "water")
# Step 1: Split baseline_data into two groups
baseline_to_match <- baseline_data |>
filter(!tolower(ingredient_name_simplified_digestibility) %in% excluded_ingredients)
baseline_excluded <- baseline_data |>
filter(tolower(ingredient_name_simplified_digestibility) %in% excluded_ingredients)
merged_data <- baseline_to_match |>
fuzzy_left_join(
protein_digestibility,
by = c("ingredient_name_simplified_digestibility" = "Protein_Source_simplified"),
match_fun = best_fuzzy_match
) |>
group_by(participant_id, time, food_item_proc_std, ingredient_name,
ingredient_name_simplified_digestibility, food_recipe_name,
volume_calc, `Protein (g)`) |>
slice_max(
calculate_match_score(ingredient_name_simplified_digestibility, Protein_Source_simplified),
n = 1,
with_ties = FALSE
) |>
ungroup() |>
full_join(baseline_excluded, by = NULL)
nrow(merged_data)
missing_digestibility = merged_data |>
filter(is.na(Protein_digestibility)) |>
select(ingredient_name, ingredient_name_simplified_digestibility)
missing_digestibility[["ingredient_name_simplified_digestibility"]] |>
unique() |> sort() |> print()
# assign digestibility = 1
merged_data = merged_data |>
mutate(
Protein_digestibility = case_when(
is.na(Protein_digestibility) ~ 1,
TRUE ~ Protein_digestibility
))
merged_data |>
select(ingredient_name_simplified_digestibility, Protein_digestibility) |> distinct(ingredient_name_simplified_digestibility, .keep_all = TRUE) |>
arrange(ingredient_name_simplified_digestibility) |>
mutate(Protein_digestibility = Protein_digestibility |> round(2)) |>
datatable(options = list(pageLength = 10,
scrollX = TRUE,
dom = 'Bfrtip'), filter = 'top',
extensions = 'Buttons',
caption = "Ingredient's Digestibility")
if(!"Kenya Food Composition Table Extracted.csv" %in% list.files(here())) {
# Extract AA_content_table from the PDF pages 193:194
KFCT_source = "Kenya Food Composition Table.pdf"
AA_content_table = extract_areas(KFCT_source, pages = 193:194)
AA_content_table = AA_content_table |>
map(~{
names(.x)[-(1:2)] = .x[2, -(1:2)]
.x = .x[-(1:3), ] |>
as_tibble()
})
AA_content_table = AA_content_table |>
map(~{
.x = .x |>
mutate(
`Food name in English` = case_when(
`Food name in English` == "raw" ~ NA_character_,
`Food name in English` == "packaged, raw" ~ NA_character_,
str_detect(`Food name in English`, "packaged\\s*\\),\\s*raw") ~ NA_character_,
`Food name in English` == "peeled, raw" ~ NA_character_,
`Food name in English` == "leaves, picked, raw" ~ NA_character_,
`Food name in English` == "stripes, raw" ~ NA_character_,
`Food name in English` == "mursik" ~ NA_character_,
`Food name in English` == "meat&skin, raw" ~ NA_character_,
`Food name in English` == "whole, dry, raw" ~ NA_character_,
`Food name in English` == "grain, fresh, raw" ~ NA_character_,
`Food name in English` == "packaged, raw" ~ NA_character_,
`Food name in English` == "grain, dry, raw" ~ NA_character_,
`Food name in English` == "fortified/sifted packaged" ~ NA_character_,
`Food name in English` == "variety, peeled, raw" ~ NA_character_,
`Food name in English` == "unsalted, dry, raw" ~ NA_character_,
`Food name in English` == "w/o bone, meat&skin, raw" ~ NA_character_,
`Food name in English` == "unsalted" ~ NA_character_,
`Food name in English` == "bones, raw" ~ NA_character_,
`Food name in English` == "dried" ~ NA_character_,
`Food name in English` == "skin, raw" ~ NA_character_,
`Food name in English` == "with white stripes, raw" ~ NA_character_,
`Food name in English` == "fleshed, peeled, raw" ~ NA_character_,
`Food name in English` == "(Lala - Industrial)" ~ NA_character_,
`Food name in English` == "(Lala - mursik)" ~ NA_character_,
`Food name in English` == "fortified/sifted packaged)," ~ NA_character_,
`Food name in English` == "leaves, raw" ~ NA_character_,
`Food name in English` == "flesh, raw" ~ NA_character_,
`Food name in English` == "picked leaves, raw" ~ NA_character_,
`Food name in English` == "Industrial)" ~ NA_character_,
`Food name in English` == "mursik)" ~ NA_character_,
TRUE ~ `Food name in English`
)) |>
mutate(across(everything(), ~ replace(., is.na(.), NA))) |>        # Keep NA in place
lapply(function(col) {
na.omit(col)  # Remove NA values from each column
}) |> do.call(what = cbind) |>
as_tibble()
return(.x)
}) |>
bind_rows() |>
rename(
Histidine = HIS,
Isoleucin = ILE,
Leucine = LEU,
Lysine = LYS,
Methionine = MET,
Phenylalanine = PHE,
Threonine = THR,
Tryptophan = TRP,
Valine = VAL) |>
select("Food name in English", "Histidine", "Isoleucin", "Leucine", "Lysine", "Methionine", "Phenylalanine", "Threonine", "Tryptophan", "Valine") |>
## NOTE: first "Milk, cow, whole, fermented"  ## second are mursik (Update appropriately) and update baseline data to separate them plus yoghurt
# Add "industrial" to the first occurrence and "mursik" to the second occurrence
mutate(
`Food name in English` = ifelse(
`Food name in English` == "Milk, cow, whole, fermented (Lala -",
ifelse(
row_number() == which(`Food name in English` == "Milk, cow, whole, fermented (Lala -")[1], paste0(`Food name in English`, "industrial"),
ifelse(
row_number() == which(`Food name in English` == "Milk, cow, whole, fermented (Lala -")[2],  paste0(`Food name in English`, "mursik"),
`Food name in English`)),
`Food name in English`
))
write_csv(AA_content_table, file = here("Kenya Food Composition Table Extracted.csv"))
}
# 4. Amino acids
AA_list = c("Histidine", "Isoleucin", "Leucine", "Lysine", "Methionine", "Phenylalanine", "Threonine", "Tryptophan", "Valine")
# From KFCT
amino_acids_kfct = read_csv(here("Kenya Food Composition Table Extracted.csv")) |>
mutate(across(-`Food name in English`, as.numeric))
# From USDA
amino_acids_usda = paste0(AA_list, ".csv") |>
map(~{
data = read_csv(here("USDA_amino_acids", .x)) |>
rename(`Food name in English` = foodDescription,  !!.x := value) |>
select(`Food name in English`, .x) |> distinct()
names(data) = gsub(".csv", "", names(data))
return(data)
}) |> reduce(full_join, by = "Food name in English") |>
mutate(across(-`Food name in English`, as.numeric)) |>
filter(
str_detect(`Food name in English`, "Lentils, sprouted, cooked, stir-fried, with salt"),
str_detect(`Food name in English`, "coriander|corriander"),
str_detect(`Food name in English`, "garlic|ginger|oil|onion"),
str_detect(`Food name in English`, "cassava|carrot|arrowroot"),
str_detect(`Food name in English`, "bread|tea|sugar"),)
amino_acids = amino_acids_kfct |>
full_join(amino_acids_usda)
# 6. Amino acid data
amino_acids = amino_acids |>
select(`Food name in English`, all_of(AA_list)) |>
mutate(
food_name_simplified = `Food name in English` |> str_to_lower(),
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "(tea).*white") ~ "tea white",
stringr::str_detect(food_name_simplified, "(tea).*black") ~ "tea black",
stringr::str_detect(food_name_simplified, "tea") ~ "tea",
TRUE ~ food_name_simplified),  # Retain existing value if none of the conditions are met
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "maize, grain, white variety, whole, dry,") ~ "maize-unrefined",
stringr::str_detect(food_name_simplified, "maize meal, sifted, fortified, packaged,") ~ "maize-refined",
stringr::str_detect(food_name_simplified, "green maize, white, whole, grain, fresh,") ~ "maize-unrefined",
stringr::str_detect(food_name_simplified, "pepper") ~ "pilipili",
TRUE ~ food_name_simplified),
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "millet"), "millet", food_name_simplified), # replace everything that contains millet to "millet"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "coriander|corriander|dhania|dhani"), "dhania", food_name_simplified), # replace everything that contains capsicum to "capsicum"
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "nightshade") ~ "blacknightshade",
stringr::str_detect(food_name_simplified, "rice") ~ "rice",
TRUE ~ food_name_simplified),  # Retain existing value if none of the conditions are met
food_name_simplified = case_when(
str_detect(food_name_simplified, "orange, pulp, raw") ~ "orange",
TRUE ~ food_name_simplified
),
food_name_simplified = case_when(
str_detect(food_name_simplified, "potato, irish \\(english\\), white variety,") ~ "potato",
TRUE ~ food_name_simplified
),
food_name_simplified = case_when(
str_detect(food_name_simplified, "sorghum") ~ "sorghum",
str_detect(food_name_simplified, "gram") ~ "green gram",
stringr::str_detect(food_name_simplified, "weetaibix|WEETABIX") ~ "wheat",
TRUE ~ food_name_simplified
),
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "wheat"), "wheat", food_name_simplified), # replace everything that contains wheat to "wheat"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "greens grams|green grams|ndengu|ndegu|baazi green|Gram"), "green gram", food_name_simplified), # replace everything that contains ndengu to "green grams"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "banana"), "banana", food_name_simplified), # replace everything that contains banana to "banana"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "spinach"), "spinach", food_name_simplified), # replace everything that contains spinach to "spinach"
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "beans|bean|geans dried") ~ "beans",  # Replace if "beans"
stringr::str_detect(food_name_simplified, "(sukuma|sukjma|kales|green fresh without stalks|kanjera|kansela).*ethiopia") ~ "ethiopian kales",
stringr::str_detect(food_name_simplified, "sukuma|sukjma|kales|green fresh without stalks|kanjera|kansela") ~ "kales",
TRUE ~ food_name_simplified),  # Retain the original value if no match
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "egg"), "eggs", food_name_simplified), # replace everything that contains egg to "eggs"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "chicken"), "chicken", food_name_simplified), # replace everything that contains chicken to "chicken"
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "chickpea|chickpeas|chick peas") ~ "chick peas",
stringr::str_detect(food_name_simplified, "peas * green") ~ "peas",
stringr::str_detect(food_name_simplified, "peas") ~ "peas",
TRUE ~ food_name_simplified),  # Retain the original value if no match
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "liver") ~ "beef liver",  # Replace if "liver" is found
stringr::str_detect(food_name_simplified, "(beef|cow).*lean") ~ "beef lean",  # Replace if "beef" or "cow" followed by "lean"
stringr::str_detect(food_name_simplified, "(beef|cow).*medium fat") ~ "beef medium",  # Replace if "medium fat beef"
stringr::str_detect(food_name_simplified, "(beef|cow).*high fat") ~ "beef high",  # Replace if "medium fat beef"
stringr::str_detect(food_name_simplified, "(beef|cow).*low fat") ~ "beef low",  # Replace if "medium fat beef"
stringr::str_detect(food_name_simplified, "beef|meat") ~ "beef",  # Replace if "beef" or "meat" is found
TRUE ~ food_name_simplified),  # Retain the original value if no match
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "omena|dagaa"), "omena", food_name_simplified), # replace everything that contains omena to "omena"
food_name_simplified = ifelse(stringr::str_detect(food_name_simplified, "sardine|sardines"), "sardine", food_name_simplified), # replace everything that contains omena to "omena"
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "(milk).*(cow).*fermented") ~ "mursik",  # Replace if "fermented cow milk"
stringr::str_detect(food_name_simplified, "yoghurt") ~ "yoghurt",
stringr::str_detect(food_name_simplified, "mursik") ~ "mursik",
stringr::str_detect(food_name_simplified, "(milk).*cow") ~ "milk cow",  # Replace if "cow milk"
stringr::str_detect(food_name_simplified, "(milk).*camel") ~ "milk camel",  # Replace if "camel milk"
stringr::str_detect(food_name_simplified, "(milk).*goat") ~ "milk goat",  # Replace if "goat milk"
stringr::str_detect(food_name_simplified, "milk|cow milk") ~ "milk cow",  # Replace if "liver" is found
TRUE ~ food_name_simplified),  # Retain the original value if no match
food_name_simplified = case_when(
stringr::str_detect(food_name_simplified, "fish") ~ "tilapia",
stringr::str_detect(food_name_simplified, "(nile).*perch") ~ "nile perch",
stringr::str_detect(food_name_simplified, "mbuta") ~ "nile perch",
stringr::str_detect(food_name_simplified, "tilapia") ~ "tilapia",
TRUE ~ food_name_simplified),  # Retain existing value if none of the conditions are met
) |>
mutate(across(all_of(AA_list), as.numeric)) |>
relocate(food_name_simplified, .after = `Food name in English`) |>
rename_with(~ paste0(., "_per_100g"), all_of(AA_list)) |>
arrange(food_name_simplified)
# optimize ingredient names for protein digestibility
merged_data = merged_data |>
mutate(
ingredient_name_simplified_AA = ingredient_name_simplified,
ingredient_name_simplified_AA = case_when(
stringr::str_detect(ingredient_name_simplified_AA, "flour.*brown") ~ "millet",
stringr::str_detect(ingredient_name_simplified_AA, "maize grain") ~ "maize unrefined",
stringr::str_detect(ingredient_name_simplified_AA, "(maize|ugali|white).*unrefined") ~ "maize unrefined",
stringr::str_detect(ingredient_name_simplified_AA, "(maize|white|ugali).*(sifted|refined|fortified|grade|jogoo|pembe|shujaa|soko)") ~ "maize refined",
stringr::str_detect(ingredient_name_simplified_AA, "ringows") ~ "maize refined",
stringr::str_detect(ingredient_name_simplified_AA, "maize|ugali") ~ "maize unrefined", # flour all purpose to move to wheat
stringr::str_detect(ingredient_name_simplified_AA, "flour all purpose") ~ "wheat flour",
# stringr::str_detect(ingredient_name_simplified_AA, "(maize|white|ugali).*(sifted|fortified)") ~ "maize refined",
# stringr::str_detect(ingredient_name_simplified_AA, "maize grain") ~ "maize grain",
# stringr::str_detect(ingredient_name_simplified_AA, "maize green fresh") ~ "maize green",
# stringr::str_detect(ingredient_name_simplified_AA, "ringows") ~ "maize refined",
# stringr::str_detect(ingredient_name_simplified_AA, "maize|ugali") ~ "maize unrefined", # flour all purpose to move to wheat
# stringr::str_detect(ingredient_name_simplified_AA, "flour all purpose") ~ "wheat flour",
TRUE ~ ingredient_name_simplified_AA),  # Retain the original value if no match
ingredient_name_simplified_AA = case_when(
stringr::str_detect(ingredient_name_simplified_AA, "maziwa mala") ~ "mursik",
stringr::str_detect(ingredient_name_simplified_AA, "chick.*peas") ~ "peas",
stringr::str_detect(ingredient_name_simplified_AA, "beans") ~ "beans",
stringr::str_detect(ingredient_name_simplified_AA, "sardine") ~ "omena",
stringr::str_detect(ingredient_name_simplified_AA, "rice") ~ "rice",
TRUE ~ ingredient_name_simplified_AA))  # Retain the original value if no match)
# 5. Update merged_data with Protein_digestibility and Protein_Source based on partial matches
cat("Excluding these ingredients from fuzzy matching (have no match hence prevent error matching):\n")
excluded_ingredients <- c("salt", "tomato", "tomato", "water")
# Step 1: Split baseline_data into two groups
merged_data_to_match <- merged_data |>
filter(!tolower(ingredient_name_simplified_AA) %in% excluded_ingredients)
merged_data_excluded <- merged_data |>
filter(tolower(ingredient_name_simplified_AA) %in% excluded_ingredients)
# Perform a join based on the simplified keys
merged_data <- merged_data_to_match |>
fuzzy_left_join(
amino_acids,
by = c("ingredient_name_simplified_AA" = "food_name_simplified"),
match_fun = best_fuzzy_match
) |>
group_by(
participant_id, time, food_item_proc_std, ingredient_name,
ingredient_name_simplified_AA, food_recipe_name,
volume_calc, `Protein (g)`
) |>
slice_max(
calculate_match_score(
ingredient_name_simplified_AA,
food_name_simplified  # <-- Correct column from amino_acids
),
n = 1,
with_ties = FALSE
) |>
full_join(merged_data_excluded, by = NULL) |>
ungroup()
missing_AA = merged_data |>
filter(is.na(`Food name in English`)) |>
select(ingredient_name, ingredient_name_simplified_AA)
missing_AA[["ingredient_name_simplified_AA"]] |>
unique() |> sort() |> print()
merged_data |>
select(ingredient_name_simplified_AA, paste0(AA_list, "_per_100g")) |> distinct(ingredient_name_simplified_AA, .keep_all = TRUE) |>
datatable(options = list(pageLength = 10,
scrollX = TRUE,
dom = 'Bfrtip'), filter = 'top',
extensions = 'Buttons',
caption = "Ingredient's Amino Acid Contents per 100 grams of food")
merged_data |>
datatable(options = list(pageLength = 10,
scrollX = TRUE,
dom = 'Bfrtip'), filter = 'top',
extensions = 'Buttons',
caption = "Ingredient's Amino Acid Contents per 100 grams of food")
